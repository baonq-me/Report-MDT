# Logical Volume Manager
# I.Giới thiệu về LVM. 
## 1. LVM là gì?
Logical Volume Manager(LVM) là phương pháp cho phép ấn định không gian lưu trữ ổ đĩa cứng thành những logical volume khiến cho việc thay đổi kích thướng dễ dàng hơn. Bạn có thể thay đổi kich thươc mà không cần phải sửa lại table của OS.

## 2. Vai trò của LVM.
LVM là kỹ thuật quản lý việc thay đổi kích thước của ổ cứng.
- Không để hệ thống gián đoạn dịch vụ.
- Không làm hỏng dịch vụ
- Có thể kết hợp Hot Swapping ( thao tác thay thế nóng các thành phần bên trong máy tính).

## 3. Các thành phần của LVM.
### Mô hình các thành phần trong LVM

![](https://i.imgur.com/ViBumEO.png)

### Hard Drives
Là các thiết bị lưu trữ vật lý, ví dụ trên hệ thống Linux được nhận diện là /dev/sda,..

### Partiton 
Là các phân vùng của các hard drive, mỗi ổ cứng có tối đa 4 phân vùng trong đó có từ 0-4 phân vùng primary, và từ 0-1 phân vùng extended. Phân cùng extended là phân vùng để tạo các phân vùng logic.

### Physical volume
Là một cách gọi khác của các partition trong kỹ thuật LVM, nó là các thành phần cơ bản được sử dụng bởi LVM. một physical volume không thể mở rộng ra phạm vi của một ổ đĩa.

### Volume group
Nhiều physical volunme trên các ổ đĩa khác nhau kết hợp với nhau để tạo thành volume group.

![](https://i.imgur.com/ufNOcQf.png)

Bootloader không thể đọc được /boot nếu nó nằm trên  Volume Group. Do đó không thể sử dụng kỹ thuật LVM với mount point /boot.

### Logical volume.
Volume Group được chia nhỏ thành các Logical Volume, mỗi Logical Volume có ý nghĩa tương tự như partition. Nó được dùng cho các mount point và được sử dụng bởi các file system khác nhau : ext3, ext4, xfs,...

![](https://i.imgur.com/oFJYDEa.png)

Khi dung lượng của Logical Volume được sử dụng hết ta có thể đưa thêm ổ đĩa mới bổ sung cho Volume Group và do đó tăng được dung lượng của Logical Volume

Ví dụ bạn có 4 ổ đĩa mỗi ổ 5GB khi bạn kết hợp nó lại thành 1 volume group 20GB, và bạn có thể tạo ra 2 logical volumes mỗi disk 10GB

# II.Sử dụng LVM.

## 1.Tạo các physical volume, volume group, logical volume.
Tạo máy ảo Centos 7 trên vmware.
Thêm hai ổ cứng 20GB:

![](https://i.imgur.com/08QAJIL.png)

Kiểm tra ổ cứng có trên hệ thống hay chưa bằng lệnh `lsblk`:
```bash
# lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0    0   20G  0 disk 
└─sda1   8:1    0   20G  0 part /
sdb      8:16   0   20G  0 disk 
sdc      8:32   0   20G  0 disk 
sr0     11:0    1 1024M  0 rom  
```
Trong đó, sdb, sdc là ổ cứng mới thêm vào.

Trên các ổ cứng **tạo ra các phân vùng LVM** bằng lệnh `fdisk`:
```
# fdisk /dev/sdb
Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1): 
First sector (2048-41943039, default 2048): 
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): +10G
Partition 1 of type Linux and of size 10 GiB is set

```
Trong đó 
- Lệnh `fdisk /dev/sdb` là lệnh để phân vùng ổ /dev/sdb
- `n` để tạo phân vùng mới trên ổ cứng.
- `p` để tạo phân vùng primary
- Partition number để mặc định là 1
- Sector đầu tiên để mặc định là 2048.
- `+10G` phần Last sector để  tạo một phân vùng 10GB

Sau Khi tạo xong phân vùng, chuyển đổib định dạng của phân vùng về LVM:
```
Command (m for help): t
Selected partition 1
Hex code (type L to list all codes): 8e
Changed type of partition 'Linux' to 'Linux LVM'

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
```
Trong đó:
- `t` để đổi id của phân vùng.
- `8e` để đổi định dạng phân vùng thành LVM
- `w` để ghi lại cấu hình trên ổ cứng.
Tương tự tạo thêm một phân vùng LVM 10G nữa trên sdb và một số phân vùng LVM trên sdc.

![](https://i.imgur.com/3yb5pxz.png)

Cài đặt gói lvm2 :`yum install -y lvm2` (trên ubuntu: `apt install -y lvm2`)

**Tạo các physical volume** từ các phân vùng mới tạo bằng lệnh pvcreate:
`pvcreate <phân vung>`
```
[root@localhost ~]# pvcreate /dev/sdb1
[root@localhost ~]# pvcreate /dev/sdb2
[root@localhost ~]# pvcreate /dev/sdc1
[root@localhost ~]# pvcreate /dev/sdc2
[root@localhost ~]# pvcreate /dev/sdc3
[root@localhost ~]# pvs
  PV         VG Fmt  Attr PSize   PFree  
  /dev/sdb1     lvm2 ---   10,00g  10,00g
  /dev/sdb2     lvm2 ---  <10,00g <10,00g
  /dev/sdc1     lvm2 ---   10,00g  10,00g
  /dev/sdc2     lvm2 ---    5,00g   5,00g
  /dev/sdc3     lvm2 ---   <5,00g  <5,00g
[root@localhost ~]# 
```
Lệnh `pvs` hay `pvdisplay` là lệnh dùng để xem các physical volume.

**Tạo Volume group** từ các physical volume dùng lệnh `vgcreate <tên vg> <phân vùng 1> <phân vùng 2> <...>`
Ví dụ:
```
[root@localhost ~]# vgcreate vg-demo1 /dev/sdb1 /dev/sdb2 /dev/sdc1 
  Volume group "vg-demo1" successfully created
[root@localhost ~]# vgs
  VG       #PV #LV #SN Attr   VSize   VFree  
  vg-demo1   3   0   0 wz--n- <29,99g <29,99g
```
Trong đó tạo volume group *vg-demo1* từ 3 phân vùng sdb1, sdb2 và sdc1.
Dùng lệnh `vgs` hoặc `vgdisplay` để hiển thị thông tin về các volume group.

**Tạo các logical volume** từ volume group vừa tạo bằng lệnh:
`lvcreate -L <dung lượng> -n <tên lv> <volume group>`
```
[root@localhost ~]# lvcreate -L 5G -n lv-demo1 vg-demo1
  Logical volume "lv-demo1" created.
[root@localhost ~]# lvs
  LV       VG       Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv-demo1 vg-demo1 -wi-a----- 5,00g            
```

**Tạo filesystem trên logical volume** sử dụng `mkfs`
```bash
# mkfs -t ext4 /dev/vg-demo1/lv-demo1
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
327680 inodes, 1310720 blocks
65536 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=1342177280
40 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done 

[root@localhost ~]# 
```
**Mount** logical volume vào hệ thống để có thể sử dụng:
```bash
[root@localhost ~]# mkdir /root/demo
[root@localhost ~]# mount /dev/vg-demo1/lv-demo1 /root/demo
[root@localhost ~]# df -Th
Filesystem                      Type      Size  Used Avail Use% Mounted on
/dev/sda1                       xfs        20G  1,2G   19G   6% /
devtmpfs                        devtmpfs  477M     0  477M   0% /dev
tmpfs                           tmpfs     488M     0  488M   0% /dev/shm
tmpfs                           tmpfs     488M  7,7M  480M   2% /run
tmpfs                           tmpfs     488M     0  488M   0% /sys/fs/cgroup
tmpfs                           tmpfs      98M     0   98M   0% /run/user/0
/dev/mapper/vg--demo1-lv--demo1 ext4      4,8G   20M  4,6G   1% /root/demo
[root@localhost ~]# 
```
## 2. Thay đổi kích thước logical volume.
Xem lại thông tin các pv, vg, lv:
```
[root@localhost ~]# pvs
  PV         VG       Fmt  Attr PSize   PFree  
  /dev/sdb1  vg-demo1 lvm2 a--  <10,00g  <5,00g
  /dev/sdb2  vg-demo1 lvm2 a--  <10,00g <10,00g
  /dev/sdc1  vg-demo1 lvm2 a--  <10,00g <10,00g
  /dev/sdc2           lvm2 ---    5,00g   5,00g
  /dev/sdc3           lvm2 ---   <5,00g  <5,00g
[root@localhost ~]# vgs
  VG       #PV #LV #SN Attr   VSize   VFree  
  vg-demo1   3   1   0 wz--n- <29,99g <24,99g
[root@localhost ~]# lvs
  LV       VG       Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv-demo1 vg-demo1 -wi-ao---- 5,00g                                                    
[root@localhost ~]# 
```
Logical volume **lv-demo1** đang có dung lượng là 5GB.
Tiến hành tăng kích thước logical volume **lv-demo1**. Logical volume **lv-demo1** được tạo từ **vg-demo1**, vì vg-demo1 vẫn còn dung lượng chống để cấp phát là 24.9GB nên có thể tăng dung lượng cho lv-demo1.
Để tăng kích thước logical volume lv-demo1 dùng lệnh:
```
[root@localhost ~]# lvextend -L +1G /dev/vg-demo1/lv-demo1
  Size of logical volume vg-demo1/lv-demo1 changed from 5,00 GiB (1280 extents) to 6,00 GiB (1536 extents).
  Logical volume vg-demo1/lv-demo1 successfully resized.
[root@localhost ~]# lvs
  LV       VG       Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv-demo1 vg-demo1 -wi-ao---- 6,00g  
[root@localhost ~]# 
```
Ta có thể thấy dung lượng lv-demo1 đã tăng từ 5GB lên 6GB tuy nhiên *filesystem trên logical volume vẫn không thay đổi kích thước*, phải dùng lệnh `resize2fs` để thay đổi kích thước filesystem:
``` bash
[root@localhost ~]# df -Th
Filesystem                      Type      Size  Used Avail Use% Mounted on
/dev/sda1                       xfs        20G  1,2G   19G   6% /
devtmpfs                        devtmpfs  477M     0  477M   0% /dev
tmpfs                           tmpfs     488M     0  488M   0% /dev/shm
tmpfs                           tmpfs     488M  7,7M  480M   2% /run
tmpfs                           tmpfs     488M     0  488M   0% /sys/fs/cgroup
tmpfs                           tmpfs      98M     0   98M   0% /run/user/0
/dev/mapper/vg--demo1-lv--demo1 ext4      4,8G   20M  4,6G   1% /root/demo
[root@localhost ~]# resize2fs /dev/vg-demo1/lv-demo1 
resize2fs 1.42.9 (28-Dec-2013)
Filesystem at /dev/vg-demo1/lv-demo1 is mounted on /root/demo; on-line resizing required
old_desc_blocks = 1, new_desc_blocks = 1
The filesystem on /dev/vg-demo1/lv-demo1 is now 1572864 blocks long.

[root@localhost ~]# df -Th
Filesystem                      Type      Size  Used Avail Use% Mounted on
/dev/sda1                       xfs        20G  1,2G   19G   6% /
devtmpfs                        devtmpfs  477M     0  477M   0% /dev
tmpfs                           tmpfs     488M     0  488M   0% /dev/shm
tmpfs                           tmpfs     488M  7,7M  480M   2% /run
tmpfs                           tmpfs     488M     0  488M   0% /sys/fs/cgroup
tmpfs                           tmpfs      98M     0   98M   0% /run/user/0
/dev/mapper/vg--demo1-lv--demo1 ext4      5,8G   20M  5,5G   1% /root/demo
```
Việc tăng dung lượng của logical volume không làm mất sữ liệu trong file system.

**Giảm kích thước logical volume**
Để giảm kích thươc logical volume thì trươc tiên cần phải unmount logical volume đó:
`# umount /dev/vg-demo1/lv-demo1`
Để giảm dung lượng lv sử dung lệnh:
`# lvreduce -L -3G /dev/vg-demo1/lv-demo1`
Sau đó cần tạo lại filesystem và mount lại
`# mkfs.ext4 /dev/vg-demo1/lv-demo1`
`# mount /dev/vg-demo1/lv-demo1 demo`
Kết quả là thay đổi được dung lượng của logical volume như việc mất dữ liệu sẽ sảy ra.
```
[root@localhost ~]# df -Th
Filesystem                      Type      Size  Used Avail Use% Mounted on
/dev/mapper/vg--demo1-lv--demo1 ext4      2,9G  9,0M  2,8G   1% /root/demo
```

## 3. Thay đổi dung lượng Volume group
Việc thay đổ dung lượng volume group chính là thay đổi nhóm các physical volume, gỡ hay thêm physical volume ra khỏi volume group.
Kiểm tra các physical volume trên máy:
```bash
[root@localhost ~]# pvs
  PV         VG       Fmt  Attr PSize   PFree  
  /dev/sdb1  vg-demo1 lvm2 a--  <10,00g  <7,00g
  /dev/sdb2  vg-demo1 lvm2 a--  <10,00g <10,00g
  /dev/sdc1  vg-demo1 lvm2 a--  <10,00g <10,00g
  /dev/sdc2           lvm2 ---    5,00g   5,00g
  /dev/sdc3           lvm2 ---   <5,00g  <5,00g
```
Ta thấy có hai physical volume sdc2, sdc3 chưa gán vào volume group nào, Có thể dùng hai physical volume này để tăng kích thước cho volume group sử dụng lệnh `vgextend`:
```
[root@localhost ~]# vgs
  VG       #PV #LV #SN Attr   VSize   VFree  
  vg-demo1   3   1   0 wz--n- <29,99g <26,99g
[root@localhost ~]# vgextend /dev/vg-demo1 /dev/sdc2
  Volume group "vg-demo1" successfully extended
[root@localhost ~]# vgs
  VG       #PV #LV #SN Attr   VSize  VFree 
  vg-demo1   4   1   0 wz--n- 34,98g 31,98g
```

Để gỡ một physical volume ra khỏi một volume group thì ta dùng lệnh `vgreduce`, chỉ gỡ được nhưng physical volume mà đang không được sử dụng.
```
[root@localhost ~]# vgs
  VG       #PV #LV #SN Attr   VSize  VFree 
  vg-demo1   4   1   0 wz--n- 34,98g 31,98g
[root@localhost ~]# vgreduce /dev/vg-demo1 /dev/sdc1 /dev/sdc2
  Removed "/dev/sdc1" from volume group "vg-demo1"
  Removed "/dev/sdc2" from volume group "vg-demo1"
[root@localhost ~]# vgs
  VG       #PV #LV #SN Attr   VSize  VFree 
  vg-demo1   2   1   0 wz--n- 19,99g 16,99g

```

## 4. Xóa Logical volume, Volume group, Physical Volume.
**Xóa logical volume**:
Để xóa được logical volume thì chúng ta cần unmount nó trước:
`umount /dev/vg-demo1/lv-demo1`
Sau đó có thể xóa logical volume với lệnh `lvremove`
`lvremove /dev/vg-demo1/lv-demo1`
**Xóa volume group**
Để xóa được volume group thì trước tiên phải xóa hết các logical volume trên nó, sau đó dùng lệnh sau để xóa vg:
`vgremove /dev/vg-demo1`
**Xóa physical volume**
Để xóa được physical volume cần xóa volume group chứa nó trước, hoặc xóa nó khỏi volume group chứa nó, sau đó dùng lệnh `pvremove` để xóa physical volume:
`pvremove /dev/sdc1`



III. Tìm hiểu bổ xung về LVM.











