# Tìm hiểu về virtual network của libvirt.


## 1. Virtual network switches.
Libvirt sử dụng virtual network switch - một phần mềm xây dựng đơn giản trên một máy chủ mà các máy ảo "cắm vào" và sử dụng để giao tiếp trong mạng.

![](https://i.imgur.com/tDMi2UV.png)

Ở trên máy chủ Linux, virtual network switch sẽ được hiển thị như là một interface. `virbr0` là một virtual switch được tạo ra mặc định khi libvirt daemon được cài đặt lên host.

![](https://i.imgur.com/chfrSdl.png)

Ta có thể thấy interface `virbr0` bằng lệnh `ip adress`:
```sh
$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eno1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc fq_codel state DOWN group default qlen 1000
    link/ether f0:1f:af:26:21:4b brd ff:ff:ff:ff:ff:ff
3: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:27:4b:55 brd ff:ff:ff:ff:ff:ff
    inet 192.168.248.1/24 brd 192.168.248.255 scope global virbr0
       valid_lft forever preferred_lft forever
$ ip addr show virbr0
3: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:27:4b:55 brd ff:ff:ff:ff:ff:ff
    inet 192.168.248.1/24 brd 192.168.248.255 scope global virbr0
       valid_lft forever preferred_lft forever
```

## 2. Network Address Translation(NAT).
Mặc định, một virtual network switch sẽ hoạt động ở chế độ NAT( sử dụng masquerading thay vì SNAT hay DNAT).
Điều này có nghĩa các máy ảo kết nối đến switch ảo, sử dụng ip của máy chủ để giao tiếp với mạng bên ngoài. Các máy ở bên ngoài sẽ không thể thiết lập kết nối với các máy ở trong khi Switch ảo hoạt động ở chế độ NAT.

![](https://i.imgur.com/J4k7WqW.png)

### DNS và DHCP.
Livirt sử dụng `dnsmasq`, tự động cấu hình và bật `dnsmasq` để làm dhcp và dns server cho mỗi virtual network switch cần nó.

![](https://i.imgur.com/RgRRdyX.png)

## 3. Chế độ Routed 
Với chế độ routed, virtual switch sẽ được kết nối đến mạng LAN vật lý của host, cho phép giao tiếp qua lại với mạng ngoài mà không cần NAT.
