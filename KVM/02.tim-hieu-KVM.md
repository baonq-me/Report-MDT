# Tìm hiểu KVM.
## Mục lục 
[1. Khái niệm ](#tongquan)
[2. Cấu trúc KVM](#cautruc)
[3. Tính năng của KVM](#tinhnang)
[4. Các mạng tr](#)
[](#)
[](#)
[](#)

<a name=tongquan> </a>

## 1. Khái niệm của KVM.
KVM (Kernel-base Virtual Machine) là một module ảo hóa mã nguồn mở được tích hợp vào Linux. Nó biến Linux thành một hypervisor và cho phép máy chủ có thể chạy nhiều máy ảo độc lập.
KVM được tích hợp vào linux kernel từ bản 2.6.20, nó yêu cầu bộ sử lý với chức năng ảo hóa phần cứng, như Intel VT hay AMD-V.
KVM cung cấp `ảo hóa phần cứng` cho rất nhiều hệ điều hành khách bao gồm Window, Linux, BSD, Solaris, Haiku, ReactOS và hệ điều hành nghiên cứu AROS. Sử dụng kết hợp với QEMU, KVM có thể chạy Mac OS X.

KVM biến Linux thành hypervisor loại 1( Base Metal). Tất cả các hypervisor đều cần một số thành phần ở mức độ hệ điều hành như trình quản lý bộ nhớ, trình lập lịch cho các tiến trình, input/output stack, driver cho các thiết bị, trình quản lý bảo mật, quản lý mạng,... để chạy máy ảo. KVM có tất cả nhưng thành phần đó vì KVM là một phần của Linux Kernel.


<a name=tinhnang></a>

## 2. Cấu trúc của kvm.
Trong kiến trúc kvm, máy ảo được coi như là những tiến trình được lập lịch bởi Linux Schedule. Thực tế thì mỗi cpu ảo xuất hiện như làm một tiến trình trong Linux, điều này cho phép kvm sử dụng được tất cả các tính năng của Linux kernel.

Cấu trúc tổng quan:

![](https://i.imgur.com/bI0CJD5.png)

Trong môi trường Linux, mỗi process thường chạy ở hai chế độ là user-mode hoặc kernel-mode. KVM đưa ra một chế độ thứ 3, đó là guest-mode. Nó dựa trên CPU có khả năng ảo hóa với kiến trúc Intel VT hoặc AMD SVM, một process trong guest-mode bao gồm cả kernel-mode và user-mode.


**Trong cấu trúc tổng quan của ảo hóa sử dụng KVM bao gồm 3 thành phần chính:**
- KVM kernel module:
  - Là một module được tích hợp vào Linux kernel.
  - Cung cấp giao diện chung cho Intel VMX và AMD SVM (thành phần hỗ trợ ảo hóa phần cứng)
- quemu – kvm: là chương trình dòng lệnh để tạo các máy ảo, thường được vận chuyển dưới dạng các package “kvm” hoặc “qemu-kvm”. Có 3 chức năng chính:
  - Thiết lập VM và các thiết bị ra vào (input/output)
  Thực thi mã khách thông qua KVM kernel module
  Mô phỏng các thiết bị ra vào (I/O) và di chuyển các guest từ host này sang host khác
- libvirt management stack:
  - Cung cấp API để các tool như virsh có thể giao tiếp và quản lí các VM
  - Cung cấp chế độ quản lí từ xa an toàn
## 3. Tính năng của KVM

### 3.1 Security – Bảo mật

KVM sử dụng kết hợp giữa SELinux và sVirt (secure virtualization) để tăng cường bảo mật và cô lập máy ảo. SELinux thiết lập danh giới bảo mật xung quanh máy ảo. sVirt mở rộng khả năng của SELinux để cung cấp cơ chế Mandatory Access Control (MAC - Kiểm soát truy cập bắt buộc) để có thể kiểm soát truy cập giữa các process, hay các máy ảo.

### 3.2 : Memory management – Quản lý bộ nhớ

KVM kế thừa những tính năng quản lý bộ nhớ của linux, bao gồm non-uniform memory access (NUMA) cho phép tận dụng hiệu quả bộ nhớ cho hệ thông đa xử lý và Kernel same-page merging cho phép các máy ảo chia sẻ vùng nhớ, các yêu cầu bộ nhớ giống nhau trên các máy ảo có thể được xử lý chung để tiết kiệm bộ nhớ để xử lý.

### 3.3 : Storage – Lưu trữ
KVM có thể sử dụng được bất kỳ bộ nhớ lưu trữ nào mà Linux hỗ trợ, bao gồm các đĩa lữu trữ cục bộ hay các hệ thống lưu trữ qua mạng. Multipath I/O có thể được sử dụng để cải thiện việc lưu trữ và cung cấp dự phòng. KVM cũng hỗ trợ chia sẻ file systems nêm image của máy ảo có thể được chia sẻ với nhiều host khác. Disk image trong KVM hỗ trợ thin provisioning, cho phép phân bố lưu trữ theo yêu cầu chứ không phải là fix cứng dung lượng lưu trữ.
Định dạng image tự nhiên của KVM là QCOW2 – hỗ trợ việc snapshot cho phép snapshot nhiều mức, nén và mã hóa dữ liệu.

### 3.4 : Live migration
KVM hỗ trợ tính năng live migration để cho phép di chuyển các máy ảo đang chạy giữa các host vật lý mà không bị gián đoạn dịch vụ. Máy ảo vẫn được bật, kết nối mạng vẫn duy trì, ứng dụng vẫn chạy trong khi máy ảo được di chuyển. KVM cũng lưu lại trạng thái của máy ảo tại thời điểm đó để có thể lưu trữ và chạy lại sau này.

### 3.5. Hardware support - Hỗ trợ phần cứng.
KVm có thể sử dụng nhiều nền tảng phần cứng mà được Linux hỗ trợ. Do các nhà phát triển phần cứng thường xuyên đóng góp cho sự phát triển của kernel, nên các tính năng phần cứng mới nhất thường được áp dụng một cách nhanh chóng cho Linux cũng như KVM.

### 3.5 : Performance and scalability
KVM kế thừa hiệu năng và khả năng mở rộng của Linux, hỗ trợ các máy ảo với 16 CPUs ảo, 256GB RAM và hệ thống máy chủ lên tới 256 cores và trên 1TB RAM.

<a name=network> </a>

## 4. Các chế dộ mạng trong KVM

Trong KVM có 3 chế độ card mạng là NAT, Public Bridge và Private Bridge.

### 4.1 NAT

Đây là cấu hình card mạng mặc định của KVM. Cơ chế NAT sẽ cấp cho mỗi VM một địa chỉ IP theo dải mặc định, nó sẽ hoạt động giống với một chiếc Router, chuyển tiếp các gói tin giữa những lớp mạng khác nhau trên một mạng lớn. Về mặt logic, ta có thể hiểu nó là 1 bridge riêng biệt và nó sẽ giao tiếp với bridge mà card mạng thật kết nối để các máy ảo có thể kết nối ra bên ngoài mạng internet. Chúng ta có thể xem dải mạng mặc định mà cơ chế NAT sẽ cấp cho các máy ảo ở trong file:

	/var/run/libvirt/network/default.xml

Các card mạng của máy ảo sẽ được gắn vào 1 bridge mặc định (vibr0), bridge này đã có gateway mặc định, các gói tin của máy ảo sẽ đi qua bridge này trước khi được chuyển tới bridge có kết nối từ card mạng thật để ra ngoài internet.

KVM sẽ cấp DHCP cho các máy dùng chế độ NAT theo dải mặc định, có thể cấu hình trong file: `/var/run/libvirt/network/default.xml`

```sh
<networkstatus>
  <class_id bitmap='0-2'/>
  <floor sum='0'/>
  <network>
    <name>default</name>
    <uuid>b3b1652d-233b-4a7b-9fbb-0c604c94dac6</uuid>
    <forward mode='nat'>
      <nat>
        <port start='1024' end='65535'/>
      </nat>
    </forward>
    <bridge name='virbr0' stp='on' delay='0'/>
    <mac address='52:54:00:56:f3:ed'/>
    <ip address='192.168.122.1' netmask='255.255.255.0'>
      <dhcp>
        <range start='192.168.122.2' end='192.168.122.254'/>
      </dhcp>
    </ip>
  </network>
</networkstatus>
```

### 4.2 Public Bridge

Chế độ này sẽ cho phép các máy ảo có cùng dải mạng vật lí với card mạng thật. Để có thể làm được điều này, bạn cần thiết lập 1 bridge và cho phép nó kết nối với cổng vật lí của thiết bị thật (eth0).

Các bước để cấu hình public bridge:

* Sử dụng câu lệnh `brctl addbr Ten_bridge` để tạo một bridge
* Gán card mạng thật cho bridge đó bằng câu lệnh `brctl addif Ten_bridge Ten_card_mang` .
* Cấu hình cho card mạng trong file: `/etc/network/interfaces` . Tại đây, hãy comment các cấu hình của card mạng vật lý và cấu hình lại cho bridge vừa tạo
* Khởi động lại dịch vụ mạng

Sau khi đã cấu hình public bridge, khi tạo máy ảo, bạn chỉ cần chọn chế độ "Bridge br0" là các máy ảo sẽ tự động được nhận các địa chỉ ip trùng với dải địa chỉ của card vật lí.

Cơ chế cấp DHCP cho các máy ảo sẽ do Router bên ngoài đảm nhận, nhờ vậy nên các VM mới có dải địa chỉ ip trùng với card vật lí bên ngoài.

<img src="img/nlDGH.jpg">


### 4.3 Private Bridge

Chế độ này sẽ sử dụng một bridge riêng biệt để các VM giao tiếp với nhau mà không ảnh hưởng tới địa chỉ của KVM host.

Ta có thể tạo ra private bridge bằng cách chỉnh sửa file `/etc/network/interfaces`. Tại đây, bạn sẽ không cần phải comment các cấu hình của card vật lý đồng thời không cần thêm tham số `bridge_ports` cho bridge.

Bạn cũng có thể tạo ra private bridge bằng cách sử dụng virt-manager.

* Trong phần `Edit`, chọn `Connection Details` -> `Virtual Networks`
* Chọn biểu tượng dấu `+`
* Điền tên
* Điền địa chỉ IP
* Chọn `Isolated virtual network` và ấn Finish

Khi tạo máy ảo và kết nối tới private bridge, các máy ảo sẽ được cấp phát địa chỉ theo dải IP mà người dùng chọn. Chúng có thể giao tiếp với nhau những không đi ra được internet.

Việc sử dụng dnsmasq trong mode này là có thể và thực tế vì nó được sử dụng để trả lời cho DHCP request.

Việc cấu hình và tạo mạng isolate sẽ tự tạo thêm bridge ảo mới cho mạng. không cần tạo trước như mạng bridge network.

Một máy ảo có thể được kết nối tới nhiều các private bridge, nhờ vậy nó có thể giao tiếp với nhau.

<a name="fileconfig"></a>

## 5. Các file cấu hình của KVM

### Thư mục chưa máy ảo

Thông tin cấu hình của máy ảo nằm ở thư mục /etc/libvirt/qemu/. Trong thư mục này sẽ chứa tất cả các file cấu hình của từng máy ảo hiện có trong KVM dưới dạng file xml. Chúng ta có thể chỉnh sửa thông tin của máy ảo trực tiếp từ file này hoặc bằng lệnh virsh edit <tên máy ảo>

Thư mục chứ các file storage của máy ảo như image thường sẽ được để ở  `/var/lib/libvirt/image`

### File log của KVM

Các file log của KVM nằm trong `/var/log/libvirt/`

Log ghi lại hoạt động của từng máy ảo nằm trong thư mục /var/log/libvirt/qemu/. Khi một máy ảo được tạo thì sẽ tự động tạo một file log cho máy ảo đó và được lưu trong thư mục này

## 6.
